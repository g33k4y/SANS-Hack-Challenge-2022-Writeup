# Solution (Exploitation Via AWS CLI)

The following is to be done using the *AWS CLI 201* terminal beside **Sulfrod**.  
If required, use the following hints to assist with this objective.
- AWS [inline policies][1] pertain to one identity while managed policies can be attached to many identities.
- You can try `s3api` or `lambda` service commands, but [Chris Elgee's talk][2] on AWS and IAM might be a good start!

[1]:https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_managed-vs-inline.html
[2]:https://youtu.be/t-xDvVUialo

---
> Use Trufflehog to find credentials in the Gitlab instance at https://haugfactory.com/asnowball/aws_scripts.git.  
> Configure these credentials for us-east-1 and then run:  
> $ aws sts get-caller-identity


We have the credentials from the previous objective *Trufflehog Search*:  
```
region_name='us-east-1'
aws_access_key_id="AKIAAIDAYRANYAHGQOHD",
aws_secret_access_key="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"
```

We follow what the upper panel says and do the `aws configure` first, then call `aws sts get-caller-identity`:

![](./res/cli201_aws_configure.png)


> Managed (think: shared) policies can be attached to multiple users. Use the AWS CLI to find any policies attached to your user.  
> The aws iam command to list attached user policies can be found here:  
> https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/index.html  
> Hint: it is NOT list-user-policies.

First, find out your username by running the following:  
`aws iam get-user` -- user is not authorized to run this command but nonetheless from the unauthorized error we can find out what the username is

![](./res/cli201_get_user.png)

Then we run the following command to find all attached user policies:  
`aws iam list-attached-user-policies --user-name haug`

![](./res/cli201_list_attached_policies.png)

> Now, view or get the policy that is attached to your user.  
> The aws iam command to get a policy can be found here:  
> https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/index.html

We can use the following command to get the policy details:  
`aws iam get-policy --policy-arn arn:aws:iam::602123424321:policy/TIER1_READONLY_POLICY`

![](./res/cli201_get_policy.png)

> Attached policies can have multiple versions. View the default version of this policy.  
> The aws iam command to get a policy version can be found here:  
> https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/index.html

We know the default version (from the previous command output), so run the following to view the default version of this policy:  
`aws iam get-policy-version --policy-arn arn:aws:iam::602123424321:policy/TIER1_READONLY_POLICY --version-id v1`

![](./res/cli201_default_policy.png)

> Inline policies are policies that are unique to a particular identity or resource. Use the AWS CLI to list the inline policies associated with your user.  
> The aws iam command to list user policies can be found here:  
> https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/index.html  
> Hint: it is NOT list-attached-user-policies.

Run the following to find the inline policies unique to this user:  
`aws iam list-user-policies --user-name haug`

![](./res/cli201_list_inline_policies.png)

> Now, use the AWS CLI to get the only inline policy for your user.  
> The aws iam command to get a user policy can be found here:  
> https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/index.html

Run the following to view the inline policy details:  
`aws iam get-user-policy --user-name haug --policy-name S3Perms`

![](./res/cli201_get_user_policy.png)

> The inline user policy named S3Perms disclosed the name of an S3 bucket that you have permissions to list objects.  
> List those objects!  
> The aws s3api command to list objects in an s3 bucket can be found here:  
> https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3api/index.html

Run the following to list all the objects in the S3 bucket:  
`aws s3api list-objects --bucket smogmachines3`

![](./res/cli201_s3_list_objects.png)

> The attached user policy provided you several Lambda privileges. Use the AWS CLI to list Lambda functions.  
> The aws lambda command to list functions can be found here:  
> https://awscli.amazonaws.com/v2/documentation/api/latest/reference/lambda/index.html

Run the following to list all the lambda functions accessibled by user:  
`aws lambda list-functions`

![](./res/cli201_lambda_list_functions.png)

> Lambda functions can have public URLs from which they are directly accessible.  
> Use the AWS CLI to get the configuration containing the public URL of the Lambda function.  
> The aws lambda command to get the function URL config can be found here:  
> https://awscli.amazonaws.com/v2/documentation/api/latest/reference/lambda/index.html

Run the following to find the public URL of the lambda:  
`aws lambda get-function-url-config --function-name smogmachine_lambda`

![](./res/cli201_lambda_public_url.png)

Once you complete all the steps, you will complete this objective and claim an achievement.